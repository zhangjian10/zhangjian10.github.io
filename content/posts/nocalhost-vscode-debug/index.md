+++
title = 'ä½¿ç”¨ Nocalhost VSCode æ’ä»¶è°ƒè¯• k8s æœåŠ¡'
date = 2022-01-10
+++

Nocalhost ç›®å‰æ”¯æŒ Jetbrains å…¨ç³»åˆ—æ’ä»¶çš„ä¸€é”®è°ƒè¯•ã€‚éšç€ Nocalhost v0.6.9 å‘å¸ƒï¼ŒVSCode ä¸€é”®è°ƒè¯•å·²æ”¯æŒ `Go`ã€`Python`ã€`Node.js`ã€`Java`ã€`Ruby`ã€`PHP` ã€‚

### ä¼ ç»Ÿè°ƒè¯•

è¿œç¨‹è°ƒè¯•ï¼ˆRemote Debugï¼‰ä¸€ç›´éƒ½æ˜¯æ’æŸ¥é—®é¢˜çš„é‡è¦æ‰‹æ®µï¼Œä½†åœ¨ k8s ç¯å¢ƒé‡Œè°ƒè¯•æœåŠ¡å¹¶ä¸æ˜¯ä¸€ä»¶ç®€å•çš„äº‹æƒ…ã€‚ä¼ ç»Ÿè°ƒè¯•æœåŠ¡éƒ½éœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š

1. ä¿®æ”¹é•œåƒï¼ˆç”¨ Debug è°ƒè¯•å™¨å¯åŠ¨çš„å¼€å‘é•œåƒï¼‰ã€‚
2. `kubectl port-forward` è½¬å‘è°ƒè¯•ç«¯å£åˆ°æœ¬åœ°ã€‚
3. é…ç½® IDE è¿æ¥åˆ°è°ƒè¯•ç«¯å£ã€‚

è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡ä»£ç ä¿®æ”¹åˆ°åé¦ˆå¤§è‡´éœ€è¦5åˆ†é’Ÿï¼ˆCI/CD)ï¼Œ è°ƒè¯•ç›¸å¯¹éº»çƒ¦ã€ç¼–ç å¾ªç¯åé¦ˆæ…¢ã€ä½“éªŒä¸ä½³ã€‚

![](./assets/old-debug.jpg)

### Nocalhost è°ƒè¯•

ä½¿ç”¨ Nocalhost åªéœ€ç®€å•é…ç½®ï¼Œå³å¯ä¸€é”®å¯åŠ¨ Debug ï¼Œä»£ç å®æ—¶åŒæ­¥è¿œç«¯å®¹å™¨ï¼Œåšåˆ°**ç§’çº§**ç¼–ç åé¦ˆï¼Œå¤§å¹…æå‡äº‘åŸç”Ÿè¡Œä¸šå¼€å‘æ•ˆç‡ã€‚

![](./assets/new-debug.jpg)

#### åŸç†

å½“æˆ‘ä»¬ä½¿ç”¨ Nocalhost è°ƒè¯•æ—¶ï¼ŒVSCode æ’ä»¶ä¼šé¦–å…ˆè¿›å…¥ `DevMode`æ¨¡å¼ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. å°†å·¥ä½œè´Ÿè½½çš„å‰¯æœ¬æ•°ç¼©å‡ä¸º1ã€‚ä¸ºäº†åœ¨é€šè¿‡`Service`è®¿é—®æ—¶åªè®¿é—®æˆ‘ä»¬æ­£åœ¨å¼€å‘çš„åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦ç¼©å‡å‰¯æœ¬æ•°ä¸º1ã€‚

2. æ›¿æ¢å®¹å™¨çš„é•œåƒä¸ºå¼€å‘é•œåƒã€‚

3. å¢åŠ ä¸€ä¸ª sidecar å®¹å™¨ã€‚åœ¨æˆ‘ä»¬ç¼–è¾‘çš„ä»£ç æ—¶å¸Œæœ›æ›´æ”¹çš„ä»£ç èƒ½å¿«é€Ÿæ›´æ–°åˆ°å·¥ä½œè´Ÿè½½ä¸­ï¼Œäºæ˜¯æˆ‘ä»¬å¢åŠ äº† sidecar æ¥å®ç°ä»£ç çš„åŒæ­¥ã€‚

åœ¨è¿›å…¥ `DevMode` åï¼Œæ’ä»¶ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. åœ¨å·¥ä½œè´Ÿè½½ä¸­æ‰§è¡Œ debug å‘½ä»¤ï¼Œå¯åŠ¨åº”ç”¨åŠè°ƒè¯•å™¨ã€‚
2. è‡ªåŠ¨å°†è¿œç¨‹è°ƒè¯•ç«¯å£è½¬å‘è‡³æœ¬åœ°éšæœºç«¯å£ã€‚
3. é€šè¿‡è°ƒè¯•åè®®è¿æ¥è°ƒè¯•ç«¯å£æ£€æµ‹è°ƒè¯•å™¨æ˜¯å¦å°±ç»ªã€‚
4. ç­‰å¾…è°ƒè¯•å™¨å°±ç»ªåï¼Œæ’ä»¶ä¼šè‡ªåŠ¨è¿æ¥è°ƒè¯•ç«¯å£å¼€å§‹è°ƒè¯•ã€‚

> å½“ä½¿ç”¨Nocalhost å¼€å‘é•œåƒæ—¶ VSCode æ’ä»¶ä¼šè‡ªåŠ¨è¯†åˆ«å¼€å‘è¯­è¨€ï¼Œå¯åŠ¨å¯¹åº”çš„è°ƒè¯•å™¨è¿›è¡Œè°ƒè¯•ã€‚
>
> å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰äº†å¼€å‘é•œåƒï¼Œå¯åŠ¨`Remote Debug`æ—¶éœ€æ ¹æ®æç¤ºé€‰æ‹©å¯¹åº”çš„å¼€å‘è¯­è¨€ã€‚

### ä½¿ç”¨æ­¥éª¤

#### å‰ç½®å‡†å¤‡

- å‡†å¤‡ä¸€ä¸ªå¯ç”¨çš„ Kubernetes é›†ç¾¤
- VSCode 1.58+
- å®‰è£… Nocalhost VSCode æ’ä»¶

#### é…ç½®

åœ¨è°ƒè¯•ä¹‹å‰ï¼Œæˆ‘ä»¬ç‚¹å‡»éœ€è¦è°ƒè¯•çš„å·¥ä½œè´Ÿè½½å³è¾¹çš„ âš™ï¸ ï¼Œè¿›è¡ŒDebugé…ç½®ã€‚

```yaml
 containers:
 - name: authors
    dev:
      image: nocalhost-docker.pkg.coding.net/nocalhost/dev-images/golang:latest
      command:
        debug:
          - ./debug.sh
      debug:
        remoteDebugPort: 9009
      ...
```

é…ç½®è¯´æ˜ï¼š

- `dev.image`ï¼šå¼€å‘é•œåƒï¼Œè¿œç¨‹è°ƒè¯•ä¾èµ–å®¹å™¨ä¸­è°ƒè¯•å™¨ï¼ˆå¦‚ goçš„Delveã€Python çš„ debugpyã€Ruby çš„ ruby-debug-ideã€PHP çš„ xdebugï¼‰ï¼Œæ‰€ä»¥åœ¨è°ƒè¯•å‰éœ€è¦æ›¿æ¢å®¹å™¨é•œåƒä¸ºå¸¦æœ‰è°ƒè¯•å™¨çš„å¼€å‘é•œåƒã€‚Nocalhost æä¾›ä»¥ä¸‹é•œåƒ,å¹¶æä¾›[æºç ](https://github.com/nocalhost/dev-container),å¹¶æä¾›åœ¨çº¿é…ç½®å·¥å…· [Tools](https://nocalhost.dev/tools/)ã€‚

  ![tools](./assets/tools.jpg)


- `dev.debug.remoteDebugPort`ï¼šè°ƒè¯•å™¨ç«¯å£ï¼Œè°ƒè¯•ä¼šå¯¹ç«¯å£æ‰§è¡Œç«¯å£è½¬å‘ï¼Œä»¥ä¾¿è¿æ¥è°ƒè¯•å™¨ã€‚

- `dev.command.debug`ï¼šdebug å¯åŠ¨å‘½ä»¤ï¼Œéœ€æŒ‰ç…§æ‚¨ä½¿ç”¨çš„è¯­è¨€è°ƒè¯•å™¨è¿›è¡Œé…ç½®,å¹¶ä¸”è°ƒè¯•å™¨ç«¯å£éœ€ä¸`dev.debug.remoteDebugPort`ä¿æŒä¸€è‡´ï¼Œå„è¯­è¨€è°ƒè¯•å™¨é…ç½®å¦‚ä¸‹ï¼š
  - Node.js ä½¿ç”¨ `--inspect=<remoteDebugPort>` å¯åŠ¨ Node.js åº”ç”¨ã€‚
  - Python ä½¿ç”¨ `debugpy` å¯åŠ¨ Python åº”ç”¨ã€‚
  - Go ä½¿ç”¨ `dlv debug`å¯åŠ¨ Go åº”ç”¨ã€‚
  - Java ä½¿ç”¨`-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,remoteDebugPort=,quiet=y`é€‰é¡¹æ¥å¯åŠ¨ Javaåº”ç”¨ã€‚
  - Ruby ä½¿ç”¨`rdebug-ide`å¯åŠ¨Rubyåº”ç”¨ã€‚
  - PHP ä½¿ç”¨`xdebug`å®ç°è¿œç¨‹è°ƒè¯•ï¼Œå¯åŠ¨å‘½ä»¤æ— éœ€æ›´æ”¹ã€‚

debug å¯åŠ¨ç¤ºä¾‹ï¼š

```shell
# node
node --inspect=<remoteDebugPort> index.js

# go
dlv debug --headless --log --listen :<remoteDebugPort> app.go

# java
java -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=<remoteDebugPort>,quiet=y -jar app.jar

# ruby
rdebug-ide -h 0.0.0.0 -p <remoteDebugPort> -- app.rb

# python
python -m debugpy --listen <remoteDebugPort> --wait-for-client app.py
```

> ä¸ºäº†èƒ½å¿«é€Ÿä½“éªŒè¿œç¨‹è°ƒè¯•ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨æ’ä»¶ä¸Šé€‰æ‹©nsç‚¹å‡»ğŸš€åœ¨å¼¹å‡ºæ¡†ä¸­é€‰æ‹© `Deploy Demo`å®‰è£… `Demo`åº”ç”¨ï¼Œå®‰è£…å®Œæˆåï¼Œå³å¯é€‰æ‹©è¦è°ƒè¯•çš„æœåŠ¡ç›´æ¥å¼€å§‹è¿œç¨‹è°ƒè¯•ã€‚

#### å¼€å§‹è°ƒè¯•

å³é”®ç‚¹å‡» `Remote Debug`ï¼Œé€‰æ‹©æºç ç›®å½•åå¼€å§‹ç­‰å¾…è°ƒè¯•å™¨å°±ç»ªã€‚(é¦–æ¬¡ä½¿ç”¨ä¼šè‡ªåŠ¨å®‰è£…ä¾èµ–æ’ä»¶,éœ€é‡å¯åå†æ¬¡ç‚¹å‡» `Remote Debug`å¼€å§‹è¿œç¨‹è°ƒè¯•)ã€‚

![debug](./assets/debug.gif)

è°ƒè¯•å¯åŠ¨åä¼šç”Ÿæˆ Nocalhost Debug é…ç½®ï¼Œåç»­å¯ç›´æ¥é€šè¿‡ `VSCode Debug` ç›´æ¥å¯åŠ¨è¿œç¨‹è°ƒè¯•ã€‚